## __Проект «Модель кредитного риск-менеджмента»__
Credit Risk Assessment. Model for predicting customer default based on loan history and delinquency data
___
## Цель проекта:
- Разработка модели для оценки кредитного риска - предсказание выхода клиента в дефолт по кредиту на основании кредитной истории и данных о просрочках
___

### __1-я часть - Препроцессинг и моделирование__ :
- файл: __`part_1_data_preprocessing_and_modeling.ipynb`__

### **Этапы работы над проектом:**

___
#### **Загрузка исходных данных**:
- **Реализовано 2 режима загрузки данных**:
    1. Загрузка в цикле 12 исходных parquet-файлов, включающих в себя шаги:
        * Предобработка данных
        * Cоздание основного датасета
        * Запись готового датасета в отдельный файл
    2. Загрузка готового датасета, сформированного в п.1
___
#### **Предобработка данных**

- Поскольку почти все исходные признаки закодированы, бинаризированы, либо являются флагами, вариантов работы с ними было немного.
- Удалось дополнительно создать следующие **новые признаки**:

**Группа количественных признаков:**
- Общее количество кредитов (кредитных продуктов) - `count_loans_total`
- Общее количество просроченных кредитов - `count_loans_overdue`
- Количество просрочек по каждому типу просрочки (5, 30, 60, 90, 90+ дней) - `count_overdue_loans...`   
- Количество различных типов (групп) просрочки - `count_overdue_types`
- Финансовые коэффициенты - Количество кредитов с:
  - Оставшейся невыплаченной суммой кредита к кредитному лимиту - `count_non_zero_util`
  - Текущей просроченной задолженности к кредитному лимиту - `count_non_zero_over2limit`
  - Максимальной просроченной задолженности к кредитному лимиту - `count_non_zero_maxover2limit`

**Группа признаков, показывающих различные соотношения (доли) от общего количества кредитов - `ratio_...`**
- Общая доля просроченных кредитов - `ratio_loans_overdue_total`
- Другие доли для: 
  - Просроченных кредитов по типам просрочки (5, 30, 60, 90, 90+ дней) - `ratio_overdue_...`
  - Непогашенных кредитов - `ratio_loans_non_zero`
  - Просроченных кредитов - `ratio_loans_non_over2limit`
  - Просроченных кредитов с максимальной задолженностью - `ratio_loans_non_maxover2limit`

- Таблица с исходными данными была свернута группировкой по id в одну строку с помощью метода OneHotEncoder

___
#### **Подготовка датасета к моделированию**

- **Понижена размерность исходного датасета** с помощью метода **SelectKBest**
  - Отобрано 65 признаков основного датасета (с учетом новых признаков), которые в преобразованном датасете трансформируются в 369 признаков
  - Отбор проводился перебором количества признаков с шагом 5 и оценкой метрики roc_auc_test с помощью модели LGBM с быстрыми настройками (в этот файл сам подбор не включен)
  - Для количества (65) исходных признаков получено максимальное значение метрики roc_auc
- Для ускорения процесса **моделирование проводилось на сокращенном датасете** (размер 15% от полного датасета, ~700 тыс записей)
  - Сокращенный датасет создан **с помощью метода undersampling** с балансировкой относительно класса 1
  - Получилось соотношение порядка 100 тыс записей класса_1 и 600 тыс записей класса_0

___
#### **Отбор моделей (2 этапа)**

- Отбор моделей проводился в несколько этапов

**1-й этап - широкий список моделей** (с быстрыми параметрами для обучения, всего 12 типов):
   - Линейные модели
     - `LogisticRegression`, `RidgeClassifier`, `SGDClassifier`
   - Древовидные ансамбли
     - `DecisionTreeClassifier`, `RandomForestClassifier`, `ExtraTreesClassifier`, `HistGradientBoostingClassifier`
   - Наивные Байесовские классификаторы
     - `GaussianNB`, `BernoulliNB`
   - Градиентный бустинг
     - `LGBMClassifier`, `XGBClassifier`, `CatBoostClassifier`

- **По итогам первого этапа** были отобраны 4 лучшие модели:
  - __`HistGradientBoostingClassifier`, `LGBMClassifier`, `XGBClassifier`, `CatBoostClassifier`__
  - Критерии отбора:
    - **Метрика roc_auc - 1-4 места; roc_auc_test > 0.75**
    - **Время обучения time_fit < 30-40 сек**
  - Среди них:
    - Лучшая метрика roc_auc_test у __`XGBClassifier`__ **0.759699**, 2-е место у __`LGBMClassifier`__ **0.758795**, 3 и 4 места у `HistGradientBoostingClassifier` и `CatBoostClassifier`
    - Лучшее время обучения у __`LGBMClassifier`__ __13 сек__, последующие места __`XGBClassifier`__ __17 сек__, `CatBoostClassifier` - __20 сек__, `HistGradientBoostingClassifier` - __34 сек__
    - Лучшая обобщающая способность у `CatBoostClassifier`, минимальная разница метрик roc_auc train и test

**2-й этап** - 4 лучших модели первого этапа - **несколько ручных вариантов расширенных параметров***:

- Список моделей - в порядке мест, занятых по значению метрики roc_auc_test:
  `XGBClassifier`, `LGBMClassifier`, `HistGradientBoostingClassifier`, `CatBoostClassifier`
- **Варианты параметров (всего 11 вариантов)**:
  - быстрые (с первого этапа)
  - против переобучения
  - оптимальные, компромисс между качеством и скоростью обучения
- **По итогам второго этапа** было отобрано 2 лучших модели с оптимальными параметрами **`XGBClassifier`** и **`LGBMClassifier`**:
  - Лучшая метрика roc_auc_test у **`XGBClassifier`** **0.763055**, у **`LGBMClassifier`** - **0.762420**. Эти показатели незначительно выше, чем у быстрых моделей первого этапа
  - Лучшее время обучения у **`LGBMClassifier`** **30 сек**, **`XGBClassifier`** - в 2 раза дольше - **59 сек**
- Кросс-валидация двух лучших моделей
  - Параметры двух лучших моделей проверены кросс-валидацией тестовых выборках на сокращенного и полного датасетов, CV = 5
  - Все проверки показали метрику значение метрики выше 0.75

___
#### **Подбор гиперпараметров**

- Проведены несколько видов подбора параметров для лучших моделей

**Метод RandomizedSearch для `LGBMClassifier`**

- **Результаты подбора оказались немного хуже**, чем у модели 2-го этапа **`LGBMClassifier_optimal`** с заданными вручную параметрами
- Заданная сетка подбора гиперпараметров и количество итераций не позволили улучшить ручные параметры модели.
- Кросс-валидация - это подтвердила. Метрика roc_auc оказалась выше 0.75, но хуже `LGBMClassifier_optimal`

**Метод Optuna для моделей `XGBClassifier` и `LGBMClassifier`**

- Было проведено несколько итераций подбора параметров
- В результате их выполнения **удалось немного улучшить показатели** моделей 2-го этапа `XGBClassifier_optimal` и `LGBMClassifier_optimal`
- Проверка на кросс-валидации - это подтвердила

___
#### **Ансамбли моделей**

- Из лучших моделей было собрано 2 варианта ансамбля **`VotingClassifier`**
  - К двум лучшим моделям `XGBClassifier` и `LGBMClassifier` была добавлена модель, занявшая 3-е место `CatBoostClassifier_optimal`, более медленная, но с лучшей обобщающей способностью
  - Взвешивание не применялось, т.к. все метрики выбранных моделей очень близкие
  - Оба варианта ансамбля показали метрику roc_auc_test лучше, чем каждая из моделей по отдельности
  - Второй вариант ансамбля занял первое место. Метрика roc_auc_test на сокращенном датасете = **0.765238**.
  - Кросс-валидация подтвердила первое место ансамбля **0.759644** - на сокращенном датасете и на полном **0.759686**
  - Минусы - модель ансамбля долго обучается относительно отдельных моделей.
  - Если время обучения будет очень критично, то лучше выбрать более простые и быстрые модели из этого проекта.

___
#### **Финальная модель**

- **Создан пайплайн (препроцессор) предобработки данных**
  - На вход подается файл (датасет) со структурой, аналогичной файлам с тренировочными данными `train_data_N.pq`
  - Финальная модель обучена и сохранена в отдельный pkl-файл
- **Тестирование модели**
  - Для тестирования модели создан отдельный файл **part_2_test_model.ipynb**
    - В нем реализован набор функций для генерации примеров и запуска тестирования предсказаний модели
    - В папке `test_data/` уже находится файл `test_data.pq` с примерами для тестирования (~1 млн записей, 120 тыс уникальных значений id)
      - Файл создан на основании всех 12-ти тренировочных файлов. По 10 тыс id из каждого файла (по 5 тыс id на каждый из классов 0 и 1)
      - Структура файла - та же, что у файлов train_data_N.pq с добавлением столбца с целевой переменной `target` (замена исходного названия `flag`)
 
___

### __2-я часть - Тестирование модели__ :
- файл: __`part_2_test_model.ipynb`__

---
### __Структура файла__

---    
* __Основная часть__
    * Загрузка модели из файла
---    
* __Проверка загруженной модели, тестирование на выборках из исходных данных__
    * Подготовка датасета с примерами для тестировани (на одном файле с исходными данными)
	* Тестирование модели (примерах из одного файла __`test_data/test_data.pq`__)
       * Результаты предсказаний записываются в файл __`test_data/prediction_results.csv`__
	* Полный цикл тестирования:
		* Чтение всех файлов с train-данными
		* Подготовка примеров для тестирования модели
        * Запись примеров в parquet-файл 
		* Предсказание.
---
### __Структура всего проекта__
```
└── credit_risk_management_prediction_model/
   ├── models/                                           # Путь для записи созданных моделей (pkl-файлы)
   ├── train_data/                                       # Путь для размещения файлов для обучения (pq-файлы). Сейчас папка пустая.
   ├── test_data/                                        # Путь для записи примеров для тестирования (pq-файлы) и результатов предсказаний (csv-файлы)
   ├── part_1_data_preprocessing_and_modeling.ipynb      # Описание и этапы работы: Загрузка данных, Предобработка, Моделирование, Оценка, Запись моделей
   └── part_2_test_model.ipynb                           # Генерация примеров для тестирования + тестирование самой модели
```

#### __Внимание!__
- Файлы с данными из-за большого размера не размещены в репозитории
- Их можно скачать по [ссылке](https://drive.google.com/drive/folders/1xCu4EWhGK-F3ps-ijtr3O5dhC7Eznun0?usp=sharing)